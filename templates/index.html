<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Gemini OCR Pro</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 30px; background: #f5f5f7; color: #1d1d1f; }
        .container { max-width: 1200px; margin: 0 auto; }
        #drop-area { 
            border: 2px dashed #0071e3; padding: 60px; text-align: center; 
            background: white; border-radius: 16px; cursor: pointer; margin-bottom: 30px;
        }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; }
        .column-card { background: white; padding: 16px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e5e5e5; }
        .column-title { font-weight: bold; color: #0071e3; border-bottom: 2px solid #f0f0f0; margin-bottom: 8px; }
        .total-box { margin-top: 12px; padding-top: 8px; border-top: 2px solid #0071e3; font-weight: bold; color: #d70035; }
        img#preview { max-width: 400px; border-radius: 12px; display: none; margin: 0 auto 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gemini OCR üßÆ „Åø„Å®„Çä„ÅÇ„Çì„Åñ„Çì</h1>
        <div id="drop-area">ÁîªÂÉè„Çí„Éö„Éº„Çπ„Éà (Cmd+V)</div>
        <center><img id="preview"></center>
        <div id="status">Ê∫ñÂÇôÂÆå‰∫Ü„ÄÇ</div>
        <div id="output" class="grid"></div>
    </div>
    <script>
        document.addEventListener('paste', async (e) => {
            const item = e.clipboardData.items[0];
            if (item && item.type.indexOf('image') !== -1) {
                const blob = item.getAsFile();
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <title>Gemini OCR Pro - Data Viewer</title>
                    <meta name="viewport" content="width=device-width,initial-scale=1" />
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; padding: 20px; background: #f5f5f7; }
                        .container { max-width: 1200px; margin: 0 auto; }
                        #drop-area { border: 2px dashed #0071e3; padding: 40px; text-align: center; background: white; border-radius: 12px; margin-bottom: 20px; cursor: copy; }
                        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
                        .column-card { background: white; padding: 14px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); font-size: 0.95em; }
                        .column-title { font-weight: 700; color: #0071e3; border-bottom: 1px solid #f0f4ff; margin-bottom: 8px; padding-bottom: 4px; }
                        .total-box { margin-top: 10px; padding-top: 6px; border-top: 1px solid #e6f0ff; font-weight: 700; color: #d70035; }
                        #debug-log { background: #111; color: #e6e6e6; padding: 12px; border-radius: 8px; margin-top: 20px; display: none; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace; max-height: 360px; overflow: auto; }
                        img#preview { max-width: 240px; display: none; margin: 10px auto; border-radius: 8px; box-shadow: 0 1px 6px rgba(0,0,0,0.08); }
                        .controls { display:flex; gap:8px; align-items:center; margin-top:12px; }
                        button { background:#0071e3; color:white; border: none; padding:8px 12px; border-radius:6px; cursor:pointer; }
                        button.secondary { background: #e6eefc; color: #0071e3; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>Gemini OCR üßÆ Ë™≠„ÅøÂèñ„ÇäÁµêÊûú</h1>
                        <div id="drop-area">„Åì„Åì„Å´ÁîªÂÉè„Çí„Éö„Éº„Çπ„Éà„Åæ„Åü„ÅØ„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó</div>
                        <center><img id="preview"></center>
                        <div id="status">ÁîªÂÉè„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>

                        <div id="output" class="grid"></div>

                        <div class="controls">
                            <button id="show-raw">Áîü„Éá„Éº„Çø„ÇíË°®Á§∫</button>
                            <button class="secondary" id="clear">„ÇØ„É™„Ç¢</button>
                        </div>
                        <div id="debug-log"></div>
                    </div>

                    <script>
                        const drop = document.getElementById('drop-area');
                        const preview = document.getElementById('preview');
                        const status = document.getElementById('status');
                        const output = document.getElementById('output');
                        const debugLog = document.getElementById('debug-log');

                        document.addEventListener('paste', async (e) => {
                            const items = Array.from(e.clipboardData.items || []);
                            const item = items.find(i => i.type.indexOf('image') !== -1);
                            if (item) {
                                const blob = item.getAsFile();
                                const reader = new FileReader();
                                reader.onload = (event) => {
                                    preview.src = event.target.result;
                                    preview.style.display = 'block';
                                    sendToGemini(event.target.result);
                                };
                                reader.readAsDataURL(blob);
                            }
                        });

                        // drag & drop support
                        drop.addEventListener('dragover', (e) => { e.preventDefault(); drop.style.opacity = '0.9'; });
                        drop.addEventListener('dragleave', () => { drop.style.opacity = '1'; });
                        drop.addEventListener('drop', (e) => {
                            e.preventDefault();
                            drop.style.opacity = '1';
                            const file = e.dataTransfer.files[0];
                            if (file && file.type.startsWith('image')) {
                                const reader = new FileReader();
                                reader.onload = (ev) => {
                                    preview.src = ev.target.result;
                                    preview.style.display = 'block';
                                    sendToGemini(ev.target.result);
                                };
                                reader.readAsDataURL(file);
                            }
                        });

                        document.getElementById('show-raw').addEventListener('click', () => {
                            debugLog.style.display = debugLog.style.display === 'block' ? 'none' : 'block';
                        });

                        document.getElementById('clear').addEventListener('click', () => {
                            preview.style.display = 'none'; preview.src = '';
                            output.innerHTML = '';
                            status.innerText = 'ÁîªÂÉè„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                            debugLog.style.display = 'none'; debugLog.innerText = '';
                        });

                        async function sendToGemini(base64Image) {
                            status.innerText = "‚è≥ Ëß£Êûê‰∏≠...";
                            output.innerHTML = "";
                            debugLog.innerText = "";

                            try {
                                const response = await fetch('/ocr', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ image: base64Image })
                                });
                                const data = await response.json();

                                debugLog.innerText = JSON.stringify(data, null, 2);

                                if (data.error) {
                                    status.innerText = "‚ùå „Ç®„É©„Éº: " + data.error;
                                } else if (Array.isArray(data.results) && data.results.length) {
                                    status.innerText = `‚úÖ ÊäΩÂá∫ÂÆå‰∫Ü (${data.results.length} Âàó)`;
                                    data.results.forEach(res => {
                                        const card = document.createElement('div');
                                        card.className = 'column-card';
                                        const numbersHtml = (res.numbers || []).map(n => `<div>${n}</div>`).join('');
                                        card.innerHTML = `
                                            <div class="column-title">Á¨¨${res.column}Âàó</div>
                                            ${numbersHtml}
                                            <div class="total-box">ÂêàË®à: ${res.total ?? ''}</div>
                                        `;
                                        output.appendChild(card);
                                    });
                                } else {
                                    status.innerText = '‚ö†Ô∏è ÁµêÊûú„ÅåÁ©∫„Åß„Åô';
                                }
                            } catch (err) {
                                status.innerText = "‚ùå ÈÄö‰ø°„Ç®„É©„Éº";
                                debugLog.innerText = err.toString();
                                debugLog.style.display = 'block';
                            }
                        }
                    </script>
                </body>
                </html>
