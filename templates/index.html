<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Gemini OCR - Precision View</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f0f2f5; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        #drop-area { border: 3px dashed #0071e3; padding: 40px; text-align: center; margin-bottom: 20px; border-radius: 12px; background: #f8fbff; cursor: pointer; }
        .table-wrapper { overflow-x: auto; margin-top: 20px; border: 1px solid #ddd; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; background: white; }
        th, td { border: 1px solid #eee; padding: 12px 8px; text-align: center; }
        th { background: #0071e3; color: white; position: sticky; top: 0; }
        tr:nth-child(even) { background: #fafafa; }
        .total-row { font-weight: bold; background: #fff0f0 !important; color: #d70035; font-size: 1.1em; }
        img#preview { max-height: 250px; display: none; margin: 10px auto; border-radius: 8px; border: 1px solid #ddd; }
        #status { font-weight: bold; color: #0071e3; margin: 15px 0; text-align: center; font-size: 1.2em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gemini OCR ğŸ§® 15åˆ—ä¸€æ‹¬æŠ½å‡º</h1>
        <div id="drop-area">
            <p>ã“ã“ã«ç”»åƒã‚’ãƒšãƒ¼ã‚¹ãƒˆ (Cmd+V)</p>
            <p style="font-size: 0.8em; color: #666;">â€»ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆç­‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„</p>
        </div>
        <center><img id="preview"></center>
        <div id="status">æº–å‚™å®Œäº†ã€‚ç”»åƒã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</div>
        
        <div class="table-wrapper">
            <table id="result-table">
                <thead><tr id="table-header"></tr></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        // ãƒšãƒ¼ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã‚’ç¢ºå®Ÿã«æ•æ‰
        document.onpaste = function(event) {
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.indexOf('image') !== -1) {
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const base64Image = event.target.result;
                        document.getElementById('preview').src = base64Image;
                        document.getElementById('preview').style.display = 'block';
                        sendToGemini(base64Image);
                    };
                    reader.readAsDataURL(blob);
                }
            }
        };

        async function sendToGemini(base64Image) {
            const status = document.getElementById('status');
            const header = document.getElementById('table-header');
            const body = document.getElementById('table-body');
            status.innerText = "â³ GeminiãŒ15åˆ—ã®æ•°å€¤ã‚’ç²¾æŸ»ä¸­...";
            
            try {
                const response = await fetch('/ocr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64Image })
                });
                const data = await response.json();
                
                if(data.error) {
                    status.innerText = "âŒ ã‚¨ãƒ©ãƒ¼: " + data.error;
                    return;
                }

                status.innerText = "âœ… æŠ½å‡ºå®Œäº†";
                // ãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆ
                header.innerHTML = "<th>No.</th>" + data.results.map(r => `<th>ç¬¬${r.column}åˆ—</th>`).join('');
                
                // è¡Œãƒ‡ãƒ¼ã‚¿ä½œæˆ (7è¡Œåˆ†)
                let bodyHtml = "";
                for (let i = 0; i < 7; i++) {
                    bodyHtml += `<tr><td>${i+1}</td>` + data.results.map(r => `<td>${r.numbers[i] || '0'}</td>`).join('') + `</tr>`;
                }
                // åˆè¨ˆè¡Œ
                bodyHtml += `<tr class="total-row"><td>åˆè¨ˆ</td>` + data.results.map(r => `<td>${r.total}</td>`).join('') + `</tr>`;
                body.innerHTML = bodyHtml;
            } catch (err) {
                status.innerText = "âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
                console.error(err);
            }
        }
    </script>
</body>
</html>
